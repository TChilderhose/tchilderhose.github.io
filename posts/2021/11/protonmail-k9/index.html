<!doctype html><html lang=en data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self'; form-action 'self'; frame-src 'self' 'https://utteranc.es'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'https://utteranc.es'; prefetch-src 'self'; connect-src 'self';"><meta name=author content="Tyler Childerhose"><meta name=description content="Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, K-9 Mail."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Connecting to ProtonMail Bridge with K-9 Mail on Android"><meta name=twitter:description content="Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, K-9 Mail."><meta property="og:title" content="Connecting to ProtonMail Bridge with K-9 Mail on Android"><meta property="og:description" content="Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, K-9 Mail."><meta property="og:type" content="article"><meta property="og:url" content="/posts/2021/11/protonmail-k9/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-03T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-03T00:00:00+00:00"><title>Connecting to ProtonMail Bridge with K-9 Mail on Android · TChilderhose</title><link rel=canonical href=/posts/2021/11/protonmail-k9/><link rel=stylesheet href=/css/site.min.a5e32c88b68cb6840da749bbb465adba1b180fd64067be7df17b2ec083d36250.css integrity="sha256-peMsiLaMtoQNp0m7tGWtuhsYD9ZAZ7598XsuwIPTYlA=" crossorigin=anonymous><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon href=/images/apple-touch-icon.png sizes=180x180><meta name=generator content="Hugo 0.103.0"><script>document.addEventListener("DOMContentLoaded",function(){document.querySelector(".preload-transitions").classList.remove("preload-transitions")})</script></head><body class=preload-transitions><aside class=float-container><ul><li><a id=to-top><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 512c141.4.0 256-114.6 256-256S397.4.0 256 0 0 114.6.0 256 114.6 512 256 512zm11.3-395.3 112 112c4.6 4.6 5.9 11.5 3.5 17.4s-8.3 9.9-14.8 9.9H304v96c0 17.7-14.3 32-32 32H240c-17.7.0-32-14.3-32-32V256H144c-6.5.0-12.3-3.9-14.8-9.9s-1.1-12.9 3.5-17.4l112-112c6.2-6.2 16.4-6.2 22.6.0z"/></svg></i></a></li><li><a id=dark-mode-toggle><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M448 256c0-106-86-192-192-192V448c106 0 192-86 192-192zm64 0c0 141.4-114.6 256-256 256S0 397.4.0 256 114.6.0 256 0 512 114.6 512 256z"/></svg></i></a></li></ul></aside><main class=wrapper><nav class=navigation id=navbar><section class=container><a class=navigation-title href=/>TChilderhose</a><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/resume/>Resume</a></li></ul></section></nav><div class=content><section class=container><aside class=toc><h2 class=toc-title>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#my-setup>My Setup</a></li><li><a href=#attempt-1---official-protonmail-bridge-deb>Attempt 1 - Official ProtonMail Bridge (deb)</a><ul><li><a href=#install>Install</a></li><li><a href=#k-9-mail>K-9 Mail</a></li><li><a href=#issues>Issues</a></li></ul></li><li><a href=#attempt-2---proxy-to-official-protonmail-bridge-deb>Attempt 2 - Proxy to Official ProtonMail Bridge (deb)</a><ul><li><a href=#socat-proxy>Socat Proxy</a></li><li><a href=#issues-1>Issues</a></li></ul></li><li><a href=#attempt-3---compile-protonmail-bridge-myself>Attempt 3 - Compile ProtonMail Bridge Myself</a><ul><li><a href=#my-repo>My Repo</a></li><li><a href=#solution>Solution</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></aside><article class=post><header><div class=post-title><h1 class=title><a class=title-link href=/posts/2021/11/protonmail-k9/>Connecting to ProtonMail Bridge with K-9 Mail on Android</a></h1></div><div class=post-meta><span class=posted-on><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M128 0c17.7.0 32 14.3 32 32V64H288V32c0-17.7 14.3-32 32-32s32 14.3 32 32V64h48c26.5.0 48 21.5 48 48v48H0V112C0 85.5 21.5 64 48 64H96V32c0-17.7 14.3-32 32-32zM0 192H448V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V192zm64 80v32c0 8.8 7.2 16 16 16h32c8.8.0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H80c-8.8.0-16 7.2-16 16zm128 0v32c0 8.8 7.2 16 16 16h32c8.8.0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H208c-8.8.0-16 7.2-16 16zm144-16c-8.8.0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8.0 16-7.2 16-16V272c0-8.8-7.2-16-16-16H336zM64 4e2v32c0 8.8 7.2 16 16 16h32c8.8.0 16-7.2 16-16V4e2c0-8.8-7.2-16-16-16H80c-8.8.0-16 7.2-16 16zm144-16c-8.8.0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8.0 16-7.2 16-16V4e2c0-8.8-7.2-16-16-16H208zm112 16v32c0 8.8 7.2 16 16 16h32c8.8.0 16-7.2 16-16V4e2c0-8.8-7.2-16-16-16H336c-8.8.0-16 7.2-16 16z"/></svg></i><time datetime=2021-11-03T00:00:00Z>2021-11-03</time></span>
&nbsp;
<span class=reading-time><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 512C114.6 512 0 397.4.0 256S114.6.0 256 0 512 114.6 512 256 397.4 512 256 512zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg></i>6-minute read</span>
&nbsp;
<span class=tags><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 80V229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5.0L418.7 317.3c25-25 25-65.5.0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7H48C21.5 32 0 53.5.0 80zm112 96c-17.7.0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"/></svg></i><a class=tag-link href=/tags/docker/>docker</a>
<span class=separator>•</span>
<a class=tag-link href=/tags/protonmail/>protonmail</a>
<span class=separator>•</span>
<a class=tag-link href=/tags/k9-mail/>K9 Mail</a>
<span class=separator>•</span>
<a class=tag-link href=/tags/android/>android</a></span></div></header><div><p>Recently I decided to look into moving away from GMail and start using a different mail service and landed on ProtonMail. My one gripe is their Android App is not great and has some nagging issues. So I wanted to see if I can use a much more well-known mail client for Android, <a href=https://k9mail.app/>K-9 Mail</a>.</p><p>The main issue with this is that ProtonMail doesn&rsquo;t have native IMAP support. But, they do have a <a href=https://protonmail.com/bridge/>ProtonMail Bridge</a> which simulates IMAP. They say ThunderBird is offically supported, which is a fairly robust Email client, so I was optimistic that I could get K-9 to work.</p><p>TL;DR Note: If you want to skip over my trys and only want to know how to get it working, you can skip to my <a href=#solution>solution</a>.</p><section><h2 id=my-setup>My Setup
<a class=heading-link href=#my-setup><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h2><p>I run a linux based server that is on my home network. It is headless (no monitor) and runs a handful of docker microservices. Most of them do not matter for this write-up, but one that does play a a fairly large role is my <a href=https://docs.linuxserver.io/images/docker-wireguard>Wireguard VPN</a> container, which my phone is 100% always connected to. This allows my to connect directly to my server from my phone using it&rsquo;s internal IP address and not needing to expose it to the internet. I highly suggest that you do not expose this to the internet.</p><p>My phone is Android 11 and has a kernal with wireguard built-in. This allows me to be connected to Wireguard all the time doesn&rsquo;t effect battery that much. K-9 mail was installed through <a href=https://f-droid.org/packages/com.fsck.k9/>f-droid</a>.</p><p>I have ProntonMail Plus, which is needed in order to use the ProtonMail Bridge.</p></section><section><h2 id=attempt-1---official-protonmail-bridge-deb>Attempt 1 - Official ProtonMail Bridge (deb)
<a class=heading-link href=#attempt-1---official-protonmail-bridge-deb><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h2><h3 id=install>Install
<a class=heading-link href=#install><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h3><p>First thing I did was download and install the <code>.deb</code> from <a href=https://protonmail.com/bridge/install>ProntonMail&rsquo;s website</a>. My linux server is normally headless, so I decided to pull out an extra monitor I had around, temporarily setup a desktop and set up my account through the gui and was given a popup similar to this:</p><p><figure><picture><source srcset=install_config-placeholder.webp data-srcset=install_config.webp type=image/webp><img src=install_config-placeholder.png data-src=install_config.png type=image/png alt="Example popup from the ProtonMail website" loading=lazy width=427 height=584></picture><figcaption><p class=caption>Example popup from the ProtonMail website</p></figcaption></figure></p><p>Looking like the bridge was up and running, I launched K-9 Mail and started adding the account.</p><h3 id=k-9-mail>K-9 Mail
<a class=heading-link href=#k-9-mail><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h3><p>I used the all the settings that ProtonMail gave me (username, password and port) but for IP address I used the internal address for my server instead of <code>127.0.0.1</code>. I also set the <code>Security</code> to <code>STARTTLS</code>.<figure><picture><source srcset=k9_setup-placeholder.webp data-srcset=k9_setup.webp type=image/webp><img src=k9_setup-placeholder.png data-src=k9_setup.png type=image/png alt="K-9 Mail Settings" loading=lazy width=432 height=889></picture><figcaption><p class=caption>K-9 Mail Settings</p></figcaption></figure></p><h3 id=issues>Issues
<a class=heading-link href=#issues><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h3><p>K-9 fails to connect. After investigating I found that the ProtonMail Bridge only listens for requests from <code>127.0.0.1</code> i.e. the same computer it&rsquo;s running on.
Alright, I know how to get arround that</p></section><section><h2 id=attempt-2---proxy-to-official-protonmail-bridge-deb>Attempt 2 - Proxy to Official ProtonMail Bridge (deb)
<a class=heading-link href=#attempt-2---proxy-to-official-protonmail-bridge-deb><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h2><h3 id=socat-proxy>Socat Proxy
<a class=heading-link href=#socat-proxy><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h3><p>I can use <code>socat</code> to proxy a different port that will accept connections from all IP addresses and proxy that to the ProtonBridge.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>socat TCP-LISTEN:25,fork TCP:127.0.0.1:1025 <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>socat TCP-LISTEN:143,fork TCP:127.0.0.1:1143 <span class=p>&amp;</span>
</span></span></code></pre></div><p>So now <code>SERVER_IP:25</code> -> <code>127.0.0.1:1025</code> and <code>SERVER_IP:143</code> -> <code>127.0.0.1:1143</code>.</p><p>I updated the ports in my K-9 settings and it connected to the server!</p><h3 id=issues-1>Issues
<a class=heading-link href=#issues-1><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h3><p>It grabbed my folders/labels from ProntonMail correctly and I was able to send emails successfully, which was good. But there was no mail showing up in my inbox or any folder. I tried go through the K-9 settings to see if I was missing something but it all looked okay.</p><p>I started going through the Android logcat to see if there was any errors thing and noticed there was an error message that K-9 was handling, <code>unsupported search query</code>.</p><p>I wasn&rsquo;t sure if this was from K-9 or from ProtonMail. Luckily both are open source so I could search and I found that it was from ProntMail</p><p><a href=https://github.com/ProtonMail/proton-bridge/blob/6ff4c8a73853a3794656e530c6f073e02a22568f/internal/imap/mailbox_messages.go#L316>ProtonMail/proton-bridge/internal/imap/mailbox_messages.go#L316</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// SearchMessages searches messages. The returned list must contain UIDs if
</span></span></span><span class=line><span class=cl><span class=c1>// uid is set to true, or sequence numbers otherwise.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>im</span> <span class=o>*</span><span class=nx>imapMailbox</span><span class=p>)</span> <span class=nf>SearchMessages</span><span class=p>(</span><span class=nx>isUID</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>criteria</span> <span class=o>*</span><span class=nx>imap</span><span class=p>.</span><span class=nx>SearchCriteria</span><span class=p>)</span> <span class=p>(</span><span class=nx>ids</span> <span class=p>[]</span><span class=kt>uint32</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span> <span class=c1>//nolint[gocyclo]
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Called from go-imap in goroutines - we need to handle panics for each function.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>defer</span> <span class=nx>im</span><span class=p>.</span><span class=nx>panicHandler</span><span class=p>.</span><span class=nf>HandlePanic</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Not</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Or</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;unsupported search query&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Body</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>criteria</span><span class=p>.</span><span class=nx>Text</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Warn</span><span class=p>(</span><span class=s>&#34;Body and Text criteria not applied&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></div><p>So either K-9 is passing <code>criteria.Not</code> or <code>criteria.Or</code> when searching for messages. It turns out it&rsquo;s <code>criteria.Not</code>.</p><p>Now I can either edit the K-9 source or ProtonMail Bridge source and try again. I decided to ProtonMail Bridge source route.</p></section><section><h2 id=attempt-3---compile-protonmail-bridge-myself>Attempt 3 - Compile ProtonMail Bridge Myself
<a class=heading-link href=#attempt-3---compile-protonmail-bridge-myself><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h2><p>As I was looking around, I found this <a href=https://github.com/shenxn/protonmail-bridge-docker>great docker setup</a> by GitHub user <code>shenxn</code>. I wish I would have found this before trying the initial setup with a gui, as this one uses the cli to login and has some good documentation of how to set it up.
They also have an example of how to build the ProtonMail Bridge from source and deploy it as a docker and funny enough was doing the same proxying I was doing.</p><h3 id=my-repo>My Repo
<a class=heading-link href=#my-repo><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h3><p>Using that repo as a reference, I decided to make <a href=https://github.com/TChilderhose/protonmail-bridge-docker>my own repo</a> for a docker image that I can apply some patches to fix stuff as I see fit.</p><p>The way that it works is</p><ol><li>I get the source code from <a href=https://github.com/ProtonMail/proton-bridge>https://github.com/ProtonMail/proton-bridge</a></li><li>I apply the patches from the <code>./patches</code> folder in my repo (currently just ignore <code>criteria.Not</code> for K-9)</li><li>Build the source</li><li>Build the docker image</li></ol><p>Then when the docker image is spun up, it creates some <code>socat</code> proxies and starts the protonmail-bridge.</p><p>With that setup, I tore down my previous attempts (uninstalled the bridge, took down the <code>socat</code> proxies) just to avoid conflicts.</p><h3 id=solution>Solution
<a class=heading-link href=#solution><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h3><p>Setting up the docker is a two step process, first you need to do initialize to get your credentials</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker run --rm -it -v /path/to/protonmail:/root ghcr.io/tchilderhose/protonmail-bridge-docker init
</span></span></code></pre></div><p>and follow the steps in the readme from the repo</p><blockquote><p>Wait for the bridge to startup, use <code>login</code> command and follow the instructions to add your account into the bridge. Then use <code>info</code> to see the configuration information (username and password). After that, use exit to <code>exit</code> the bridge. You may need <code>CTRL+C</code> to exit the docker entirely.</p></blockquote><p>This will place a bunch of files needed for the bridge in the <code>/path/to/protonmail</code> folder (feel free to change this beforehand).</p><p>Then you can spin up the actual bridge for use. I use <code>docker-compose</code> so I just added</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>  protonmail:
</span></span><span class=line><span class=cl>    image:  ghcr.io/tchilderhose/protonmail-bridge-docker
</span></span><span class=line><span class=cl>    container_name: protonmail
</span></span><span class=line><span class=cl>    restart: unless-stopped
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - &#34;1025:25/tcp&#34;
</span></span><span class=line><span class=cl>      - &#34;1143:143/tcp&#34;
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - /path/to/protonmail:/root
</span></span></code></pre></div><p>With that running I updated my K-9 settings with those port numbers (1025, 1143) and it worked! All my emails started showing up and it all seemed to be working.</p></section><section><h2 id=summary>Summary
<a class=heading-link href=#summary><i class="fa inline-svg" aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path fill="currentcolor" d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6 31.5 31.5 31.5 82.5.0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5.0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5 50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0 27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5.0L60.2 244.3z"/></svg></i></a></h2><p>The final connection path: (Again, I highly suggest that you do not expose the docker to the internet and connect to it through a secure VPN.)</p><p><code>K9 Mail</code> -> <code>Wireguard Tunnel to my Server</code> -> <code>protonmail-bridge-docker</code> -> <code>ProtonMail Bridge</code> -> <code>ProtonMail Servers</code></p><p>Getting this working took a few attempts, but it wasn&rsquo;t overall too bad. While it&rsquo;s only been a few days that it&rsquo;s been setup, I&rsquo;ve had no issues and have been really happy with it. There is a lot of good settings and documentation to play around with in K-9 to get it setup to my likeing.</p><p>The one thing that is missing is sending via an alias. This isn&rsquo;t something I&rsquo;ve needed to do yet, snor do I think I will really do, but it is something to consider.</p><p>ProtonMail keep saying a new mobile app will be rolling out by years end, so if/when that drops, I will need to reevaluate if I will switch to that or keep this setup. But currently I am really liking it so will probably be sticking with it for awhile.</p></section></div><footer><div id=utterance-container src=https://utteranc.es/client.js repo=TChilderhose/tchilderhose.github.io issue-term=pathname label=comment crossorigin=anonymous></div></footer></article></section></div><footer class=footer><section class=container>©
2021 -
2022
Tyler Childerhose
·
Powered by <a href=https://gohugo.io/>Hugo</a>.</section></footer></main><script defer src=/js/site.min.46ebcecfb3d9cc5c45250d00e7f07257d3660084e39375063e882d103b67a78b.js integrity="sha256-RuvOz7PZzFxFJQ0A5/ByV9NmAITjk3UGPogtEDtnp4s=" crossorigin=anonymous></script></body></html>